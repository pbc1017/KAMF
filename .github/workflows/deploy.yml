name: Deploy to Server

on:
  workflow_run:
    workflows: ['Docker Build & Push']
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy'
        required: false
        default: 'latest'

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set deployment variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
          else
            IMAGE_TAG="${{ github.sha }}"
          fi

          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "deployment_time=$(date '+%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create deployment environment file
        run: |
          cat > .env.deploy << EOF
          # Docker Configuration
          DOCKER_REGISTRY=${{ secrets.DOCKERHUB_USERNAME }}
          IMAGE_TAG=${{ steps.vars.outputs.image_tag }}

          # Application Environment
          NODE_ENV=production
          SERVER_PORT=8000
          API_PREFIX=api
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN_PROD }}

          # Next.js Environment (ëŸ°íƒ€ìž„ì—ëŠ” ë¶ˆí•„ìš”í•˜ì§€ë§Œ ì¼ê´€ì„±ì„ ìœ„í•´ í¬í•¨)
          NEXT_PORT=3000

          # Database Configuration
          DB_HOST=mysql
          DB_PORT=3306
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}

          # JWT & Authentication
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN=1h
          REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
          REFRESH_TOKEN_EXPIRES_IN=7d
          NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}

          # Twilio SMS Configuration
          TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_SERVICE_SID=${{ secrets.TWILIO_SERVICE_SID }}

          # Deployment Metadata
          DEPLOYMENT_TIME=${{ steps.vars.outputs.deployment_time }}
          DEPLOYED_BY=${{ github.actor }}
          COMMIT_SHA=${{ github.sha }}
          EOF

      - name: Copy deployment files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: 'deploy/,.env.deploy'
          target: '/home/${{ secrets.SERVER_USERNAME }}/kamf/'
          strip_components: 0
          overwrite: true

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e

            echo "ðŸš€ Starting deployment to production server..."
            echo "ðŸ“¦ Image Tag: ${{ steps.vars.outputs.image_tag }}"
            echo "ðŸ‘¤ Deployed by: ${{ github.actor }}"
            echo "ðŸ”– Commit: ${{ github.sha }}"

            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/${{ secrets.SERVER_USERNAME }}/kamf

            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            if [ ! -f .env.deploy ]; then
              echo "âŒ .env.deploy file not found!"
              exit 1
            fi

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x deploy/scripts/deploy.sh

            # ë°°í¬ ì‹¤í–‰
            echo "ðŸ“¥ Executing deployment script..."
            ./deploy/scripts/deploy.sh

            # ë³´ì•ˆ: í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ì œê±°
            rm -f .env.deploy

            echo "âœ… Deployment completed successfully!"

      - name: Verify deployment status
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "âœ… Deployment verification completed"
            echo "ðŸ“Š Final container status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep kamf

  notify:
    name: Notify Deployment Result
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Notify Slack
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          STATUS="${{ needs.deploy.result }}"
          if [ "$STATUS" = "success" ]; then
            STATUS_KR="ì„±ê³µ"
            EMOJI="ðŸŽ‰"
            COLOR="good"
          else
            STATUS_KR="ì‹¤íŒ¨"
            EMOJI="ðŸ’¥"
            COLOR="danger"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"title\": \"${EMOJI} ë°°í¬ ${STATUS_KR}\",
                \"fields\": [
                  {\"title\": \"í”„ë¡œì íŠ¸\", \"value\": \"KAMF\", \"short\": true},
                  {\"title\": \"í™˜ê²½\", \"value\": \"Production\", \"short\": true},
                  {\"title\": \"ë¸Œëžœì¹˜\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"ë°°í¬ìž\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"ì»¤ë°‹\", \"value\": \"${{ github.sha }}\", \"short\": false},
                  {\"title\": \"ì‹œê°„\", \"value\": \"$(date '+%Y-%m-%d %H:%M:%S')\", \"short\": false}
                ]
              }]
            }" \
            "${{ vars.SLACK_WEBHOOK_URL }}"

      - name: Create deployment record
        if: needs.deploy.result == 'success'
        run: |
          echo "ðŸ“ Deployment record created:"
          echo "  - Status: ${{ needs.deploy.result }}"
          echo "  - Image Tag: ${{ github.sha }}"
          echo "  - Deployed by: ${{ github.actor }}"
          echo "  - Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
